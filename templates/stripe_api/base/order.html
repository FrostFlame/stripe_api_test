{% extends "stripe_api/base/base_page.html" %}
{% block title %}
    {{ order.name }}
{% endblock %}

{% block content %}

    <h1>{{ order.name }}</h1>
    <h3>Состав заказа:</h3>
    <ul>
        {% for item in order.items.all %}
            <li>
                <h4>{{ item.description }}</h4>
                <h4>{{ item.price }} руб.</h4>
            </li>
        {% endfor %}
    </ul>
    {% if order.discount %}
        <h3>Скидки:</h3>
        <h4>-{{ order.discount.name }}</h4>
        <h4>{{ order.discount.percent_off }}%</h4>
    {% endif %}
    {% if order.taxes %}
        <h3>Налоги:</h3>
        {% for tax in order.taxes.all %}
            <ul>
                <li>
                    <h4>{{ tax.name }}</h4>
                    <h4>{{ tax.percentage }}%</h4>
                </li>
            </ul>
        {% endfor %}
    {% endif %}
    <form>
        <button onclick="checkout()" type="button">Оплатить</button>
    </form>

    <script>
        function checkout() {
            var stripe = Stripe('pk_test_51LiJ36BdQlbmWvVsquE48L8M6AoMnYwmvvfpA9gRIeAWM2or77l7dThaprSp3xmlYooQ5X6bnnXBytI1OBSyjAbj00qBjU0map');
            fetch('/order_bulk/{{ order.id }}', {
                method: 'GET',
            })
                .then(function (response) {
                    return response.json();
                })
                .then(function (session) {
                    return stripe.redirectToCheckout({sessionId: session});
                })
                .then(function (result) {
                    if (result.error) {
                        alert(result.error.message);
                    }
                });
        }
    </script>
{% endblock %}